{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "dialog.schema.json",
  "title": "Dialog Tree Definition",
  "description": "Defines a dialog tree for in-game conversations",
  "type": "object",
  "required": ["id", "nodes", "startNodeId"],

  "properties": {
    "id": {
      "type": "string",
      "pattern": "^dialog_[a-z0-9_]+$"
    },
    "title": {
      "type": "string"
    },
    "participants": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Character IDs in this dialog"
    },
    "nodes": {
      "type": "array",
      "items": { "$ref": "#/definitions/dialogNode" },
      "minItems": 1
    },
    "startNodeId": {
      "type": "string"
    },
    "canSkip": {
      "type": "boolean",
      "default": true
    },
    "pauseGame": {
      "type": "boolean",
      "default": false
    },
    "characters": {
      "type": "array",
      "items": { "$ref": "#/definitions/dialogCharacter" }
    }
  },

  "definitions": {
    "dialogNode": {
      "type": "object",
      "required": ["id", "characterId", "text"],
      "properties": {
        "id": {
          "type": "string"
        },
        "characterId": {
          "type": "string"
        },
        "text": {
          "type": "string"
        },
        "emotion": {
          "type": "string",
          "enum": ["neutral", "happy", "sad", "angry", "surprised", "fearful", "disgusted", "thoughtful"],
          "default": "neutral"
        },
        "voiceFile": {
          "type": "string"
        },
        "displayDuration": {
          "type": "number",
          "description": "-1 = wait for input"
        },
        "choices": {
          "type": "array",
          "items": { "$ref": "#/definitions/dialogChoice" }
        },
        "nextNodeId": {
          "type": "string",
          "description": "Auto-advance if no choices"
        },
        "autoAdvance": {
          "type": "boolean",
          "default": false
        },
        "autoAdvanceDelay": {
          "type": "number",
          "default": 3.0
        },
        "condition": {
          "type": "string",
          "description": "Show only if condition met"
        },
        "portraitPosition": {
          "type": "string",
          "enum": ["left", "right", "center"],
          "default": "left"
        },
        "backgroundEffect": {
          "type": "string"
        },
        "cameraTarget": {
          "type": "string",
          "description": "Unit ID to focus camera on"
        },
        "soundEffect": {
          "type": "string"
        },
        "onEnterScript": {
          "type": "string"
        },
        "onExitScript": {
          "type": "string"
        }
      }
    },

    "dialogChoice": {
      "type": "object",
      "required": ["id", "text"],
      "properties": {
        "id": {
          "type": "string"
        },
        "text": {
          "type": "string"
        },
        "tooltip": {
          "type": "string"
        },
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "requiredFlag": {
          "type": "string",
          "description": "Flag required to show choice"
        },
        "setFlag": {
          "type": "string",
          "description": "Flag to set when selected"
        },
        "nextNodeId": {
          "type": "string"
        },
        "onSelectScript": {
          "type": "string"
        },
        "skillCheck": {
          "$ref": "#/definitions/skillCheck"
        }
      }
    },

    "skillCheck": {
      "type": "object",
      "properties": {
        "skill": {
          "type": "string"
        },
        "difficulty": {
          "type": "integer"
        },
        "successNodeId": {
          "type": "string"
        },
        "failNodeId": {
          "type": "string"
        }
      }
    },

    "dialogCharacter": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "title": {
          "type": "string"
        },
        "portraits": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Emotion to portrait path mapping"
        },
        "defaultPortrait": {
          "type": "string"
        },
        "voiceStyle": {
          "type": "string"
        },
        "faction": {
          "type": "string"
        },
        "textColor": {
          "type": "string"
        }
      }
    }
  }
}
