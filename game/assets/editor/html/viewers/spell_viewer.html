<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spell Viewer - Nova3D Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <style>
        :root { --bg-primary: #1e1e1e; --bg-secondary: #252526; --bg-tertiary: #2d2d30; --bg-hover: #3e3e42; --border-color: #3c3c3c; --text-primary: #cccccc; --text-secondary: #9d9d9d; --text-bright: #ffffff; --accent-primary: #007acc; --success: #4ec9b0; --warning: #dcdcaa; --error: #f14c4c; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 13px; color: var(--text-primary); background: var(--bg-primary); height: 100vh; overflow: hidden; }
        .viewer-container { display: flex; flex-direction: column; height: 100vh; }
        .toolbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        .toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 8px; }
        .toolbar h1 { font-size: 16px; font-weight: 500; color: var(--text-bright); }
        .dirty-indicator { color: var(--warning); font-size: 18px; display: none; }
        .btn { padding: 6px 12px; font-size: 13px; color: var(--text-primary); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; cursor: pointer; }
        .btn:hover { background: var(--bg-hover); }
        .btn-primary { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        .btn-add { color: var(--success); border-style: dashed; }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .properties-panel { width: 350px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); overflow-y: auto; }
        .preview-area { flex: 1; display: flex; flex-direction: column; }
        .preview-canvas { flex: 1; position: relative; }
        .preview-canvas canvas { width: 100% !important; height: 100% !important; }
        .preview-controls { display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); }
        .section { border-bottom: 1px solid var(--border-color); }
        .section-header { display: flex; align-items: center; padding: 10px 12px; cursor: pointer; font-weight: 500; color: var(--text-bright); user-select: none; }
        .section-header:hover { background: var(--bg-hover); }
        .section-header .icon { margin-right: 8px; font-size: 10px; transition: transform 0.2s; }
        .section.collapsed .section-header .icon { transform: rotate(-90deg); }
        .section.collapsed .section-content { display: none; }
        .section-content { padding: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; color: var(--text-secondary); font-size: 12px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 6px 8px; font-size: 13px; color: var(--text-primary); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 3px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); }
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; }
        .stat-row label { width: 120px; margin-bottom: 0; }
        .stat-row input, .stat-row select { flex: 1; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary); }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--text-bright); border-bottom-color: var(--accent-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .targeting-preview { position: relative; padding: 20px; background: var(--bg-tertiary); border-radius: 4px; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .targeting-circle { border: 2px solid var(--accent-primary); border-radius: 50%; background: rgba(0,122,204,0.2); }
        .targeting-cone { width: 0; height: 0; border-style: solid; }
        .targeting-line { background: var(--accent-primary); opacity: 0.5; }
        .effect-item { padding: 10px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--accent-primary); }
        .effect-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .timeline-container { background: var(--bg-tertiary); border-radius: 4px; padding: 12px; }
        .timeline-track { height: 30px; background: var(--bg-hover); margin-bottom: 4px; border-radius: 3px; position: relative; }
        .timeline-event { position: absolute; height: 100%; background: var(--accent-primary); border-radius: 3px; cursor: pointer; display: flex; align-items: center; padding: 0 8px; font-size: 11px; color: white; }
        .cost-editor { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .cost-item { display: flex; align-items: center; gap: 4px; }
        .cost-item label { width: 60px; margin: 0; font-size: 11px; }
        .cost-item input { flex: 1; }
        .python-editor { border: 1px solid var(--border-color); border-radius: 3px; overflow: hidden; }
        .CodeMirror { height: 150px; font-size: 12px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <button class="btn" onclick="goBack()">Back</button>
                <h1 id="spell-title">Spell Viewer</h1>
                <span class="dirty-indicator" id="dirty-indicator">*</span>
            </div>
            <div class="toolbar-right">
                <button class="btn" onclick="loadConfig()">Load</button>
                <button class="btn" onclick="undo()">Undo</button>
                <button class="btn" onclick="redo()">Redo</button>
                <button class="btn btn-primary" onclick="saveConfig()">Save</button>
            </div>
        </div>

        <div class="main-content">
            <div class="properties-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="general">General</div>
                    <div class="tab" data-tab="targeting">Targeting</div>
                    <div class="tab" data-tab="effects">Effects</div>
                    <div class="tab" data-tab="callbacks">Callbacks</div>
                </div>

                <div class="tab-content active" id="tab-general">
                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Basic Info</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>ID</label><input type="text" data-path="id" readonly></div>
                            <div class="form-group"><label>Name</label><input type="text" data-path="name"></div>
                            <div class="form-group"><label>Description</label><textarea data-path="description" rows="3"></textarea></div>
                            <div class="form-group"><label>Type</label>
                                <select data-path="type">
                                    <option value="damage">Damage</option>
                                    <option value="heal">Heal</option>
                                    <option value="buff">Buff</option>
                                    <option value="debuff">Debuff</option>
                                    <option value="summon">Summon</option>
                                    <option value="utility">Utility</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Icon</label>
                                <div style="display:flex;gap:8px">
                                    <input type="text" data-path="icon">
                                    <button class="btn btn-small" onclick="browseIcon()">Browse</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Cost & Cooldown</span>
                        </div>
                        <div class="section-content">
                            <div class="cost-editor">
                                <div class="cost-item"><label>Mana</label><input type="number" data-path="cost.mana" value="50" min="0"></div>
                                <div class="cost-item"><label>Health</label><input type="number" data-path="cost.health" value="0" min="0"></div>
                                <div class="cost-item"><label>Energy</label><input type="number" data-path="cost.energy" value="0" min="0"></div>
                                <div class="cost-item"><label>Rage</label><input type="number" data-path="cost.rage" value="0" min="0"></div>
                            </div>
                            <div class="stat-row" style="margin-top:12px"><label>Cooldown (s)</label><input type="number" data-path="cooldown" value="10" min="0" step="0.1"></div>
                            <div class="stat-row"><label>Cast Time (s)</label><input type="number" data-path="castTime" value="0" min="0" step="0.1"></div>
                            <div class="stat-row"><label>Charges</label><input type="number" data-path="charges.max" value="1" min="1"></div>
                            <div class="stat-row"><label>Recharge Time</label><input type="number" data-path="charges.rechargeTime" value="0" min="0" step="0.1"></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Damage/Healing</span>
                        </div>
                        <div class="section-content">
                            <div class="stat-row"><label>Base Value</label><input type="number" data-path="damage.base" value="100" min="0"></div>
                            <div class="form-group"><label>Damage Type</label>
                                <select data-path="damage.type">
                                    <option value="physical">Physical</option>
                                    <option value="magic">Magic</option>
                                    <option value="fire">Fire</option>
                                    <option value="ice">Ice</option>
                                    <option value="lightning">Lightning</option>
                                    <option value="poison">Poison</option>
                                    <option value="true">True</option>
                                </select>
                            </div>
                            <div class="stat-row"><label>AP Scaling</label><input type="number" data-path="damage.apScaling" value="0.5" min="0" max="5" step="0.01"></div>
                            <div class="stat-row"><label>AD Scaling</label><input type="number" data-path="damage.adScaling" value="0" min="0" max="5" step="0.01"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-targeting">
                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Targeting Mode</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>Type</label>
                                <select data-path="targeting.type" onchange="updateTargetingPreview()">
                                    <option value="self">Self</option>
                                    <option value="point">Point (Ground)</option>
                                    <option value="unit">Unit Target</option>
                                    <option value="direction">Direction</option>
                                    <option value="vector">Vector (Line)</option>
                                    <option value="none">None (Auto)</option>
                                </select>
                            </div>
                            <div class="form-group"><label>
                                <input type="checkbox" data-path="targeting.requiresTarget"> Requires Valid Target
                            </label></div>
                            <div class="form-group"><label>
                                <input type="checkbox" data-path="targeting.canTargetSelf"> Can Target Self
                            </label></div>
                            <div class="form-group"><label>
                                <input type="checkbox" data-path="targeting.canTargetAlly"> Can Target Allies
                            </label></div>
                            <div class="form-group"><label>
                                <input type="checkbox" data-path="targeting.canTargetEnemy" checked> Can Target Enemies
                            </label></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Area of Effect</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>AOE Shape</label>
                                <select data-path="aoe.shape" onchange="updateTargetingPreview()">
                                    <option value="none">None (Single Target)</option>
                                    <option value="circle">Circle</option>
                                    <option value="cone">Cone</option>
                                    <option value="line">Line</option>
                                    <option value="rectangle">Rectangle</option>
                                </select>
                            </div>
                            <div class="stat-row"><label>Radius/Width</label><input type="number" data-path="aoe.radius" value="5" min="0" step="0.5" onchange="updateTargetingPreview()"></div>
                            <div class="stat-row"><label>Length/Range</label><input type="number" data-path="aoe.length" value="10" min="0" step="0.5" onchange="updateTargetingPreview()"></div>
                            <div class="stat-row"><label>Angle (Cone)</label><input type="number" data-path="aoe.angle" value="60" min="0" max="360" onchange="updateTargetingPreview()"></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Range</span>
                        </div>
                        <div class="section-content">
                            <div class="stat-row"><label>Cast Range</label><input type="number" data-path="range" value="10" min="0" step="0.5"></div>
                            <div class="stat-row"><label>Min Range</label><input type="number" data-path="minRange" value="0" min="0" step="0.5"></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Projectile</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>
                                <input type="checkbox" data-path="projectile.enabled"> Use Projectile
                            </label></div>
                            <div class="form-group"><label>Projectile ID</label><input type="text" data-path="projectile.id" placeholder="projectile_fireball"></div>
                            <div class="stat-row"><label>Speed</label><input type="number" data-path="projectile.speed" value="20" min="0" step="0.5"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-effects">
                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Effect Timeline</span>
                        </div>
                        <div class="section-content">
                            <div class="timeline-container" id="effect-timeline">
                                <div class="timeline-track" id="timeline-track">
                                    <!-- Events added dynamically -->
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary);margin-top:4px">
                                    <span>0s</span>
                                    <span id="timeline-duration">2s</span>
                                </div>
                            </div>
                            <div style="margin-top:8px;display:flex;gap:8px">
                                <input type="number" id="timeline-total" value="2" min="0.1" step="0.1" style="width:60px" onchange="updateTimelineDuration()">
                                <span style="line-height:28px">seconds</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Applied Effects</span>
                        </div>
                        <div class="section-content">
                            <div id="applied-effects"></div>
                            <button class="btn btn-small btn-add" onclick="addEffect()">+ Add Effect</button>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Visual Effects</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>Cast Particle</label><input type="text" data-path="visuals.cast"></div>
                            <div class="form-group"><label>Impact Particle</label><input type="text" data-path="visuals.impact"></div>
                            <div class="form-group"><label>Area Indicator</label><input type="text" data-path="visuals.areaIndicator"></div>
                            <div class="form-group"><label>Cast Animation</label><input type="text" data-path="visuals.animation"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-callbacks">
                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Python Script</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>Script Path</label>
                                <div style="display:flex;gap:8px">
                                    <input type="text" data-path="callbacks.script">
                                    <button class="btn btn-small" onclick="browsePython()">Browse</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Event Callbacks</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group"><label>OnCastStart</label><input type="text" data-path="callbacks.onCastStart" placeholder="on_spell_cast_start"></div>
                            <div class="form-group"><label>OnCastComplete</label><input type="text" data-path="callbacks.onCastComplete" placeholder="on_spell_cast_complete"></div>
                            <div class="form-group"><label>OnHit</label><input type="text" data-path="callbacks.onHit" placeholder="on_spell_hit"></div>
                            <div class="form-group"><label>OnProjectileHit</label><input type="text" data-path="callbacks.onProjectileHit" placeholder="on_projectile_hit"></div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header" onclick="toggleSection(this)">
                            <span class="icon">&#x25BC;</span>
                            <span>Inline Script</span>
                        </div>
                        <div class="section-content">
                            <div class="python-editor"><div id="python-editor"></div></div>
                            <div style="margin-top:8px"><button class="btn btn-small" onclick="testScript()">Test Script</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-area">
                <div class="preview-canvas" id="preview-container">
                    <canvas id="preview-canvas"></canvas>
                </div>
                <div class="preview-controls">
                    <button class="btn btn-small" onclick="previewSpell()">Preview Spell</button>
                    <button class="btn btn-small" onclick="resetCamera()">Reset Camera</button>
                    <label><input type="checkbox" id="show-aoe" checked onchange="toggleAOEView()"> Show AOE</label>
                    <label><input type="checkbox" id="show-range" onchange="toggleRangeView()"> Show Range</label>
                </div>
            </div>
        </div>
    </div>

    <script src="../editor_core.js"></script>
    <script src="../js/viewer_common.js"></script>
    <script>
        let viewerScene, targetingVis, pythonEditor, configData = {}, originalData = {}, undoStack = [], redoStack = [], currentFile = null;

        document.addEventListener('DOMContentLoaded', function() {
            initScene();
            initTabs();
            initFormBindings();
            initPythonEditor();
            setDefaultConfig();
        });

        function initScene() {
            viewerScene = new ViewerScene('preview-canvas', { cameraPosition: { x: 0, y: 15, z: 15 } });
            targetingVis = new TargetingVisualizer(viewerScene.scene);
        }

        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                });
            });
        }

        function initFormBindings() {
            document.querySelectorAll('[data-path]').forEach(input => {
                input.addEventListener('change', function() {
                    saveUndoState();
                    setPath(configData, this.getAttribute('data-path'), getInputValue(this));
                    setDirty(true);
                });
            });
        }

        function initPythonEditor() {
            if (typeof CodeMirror !== 'undefined') {
                pythonEditor = CodeMirror(document.getElementById('python-editor'), {
                    mode: 'python', theme: 'material-darker', lineNumbers: true, indentUnit: 4,
                    value: '# Spell callback script\n\ndef on_spell_cast_start(caster, target, position):\n    pass\n\ndef on_spell_hit(caster, target, damage):\n    return damage\n'
                });
            }
        }

        function setDefaultConfig() {
            configData = {
                id: 'spell_new', name: 'New Spell', description: '', type: 'damage',
                cost: { mana: 50 }, cooldown: 10, castTime: 0, charges: { max: 1 },
                damage: { base: 100, type: 'magic', apScaling: 0.5 },
                targeting: { type: 'unit', canTargetEnemy: true },
                aoe: { shape: 'none', radius: 5 }, range: 10, effects: [], callbacks: {}
            };
            originalData = JSON.parse(JSON.stringify(configData));
            populateForm();
            updateTargetingPreview();
        }

        function updateTargetingPreview() {
            targetingVis.clear();
            const shape = getPath(configData, 'aoe.shape') || 'none';
            const radius = getPath(configData, 'aoe.radius') || 5;
            const length = getPath(configData, 'aoe.length') || 10;
            const angle = getPath(configData, 'aoe.angle') || 60;

            switch (shape) {
                case 'circle': targetingVis.showCircle(radius); break;
                case 'cone': targetingVis.showCone(angle, length); break;
                case 'line': targetingVis.showLine(1, length); break;
                case 'rectangle': targetingVis.showRectangle(radius * 2, length); break;
            }
        }

        function addEffect() {
            if (!configData.effects) configData.effects = [];
            saveUndoState();
            configData.effects.push({ effectId: '', duration: 5, stacks: 1 });
            updateEffectsList();
            setDirty(true);
        }

        function updateEffectsList() {
            document.getElementById('applied-effects').innerHTML = (configData.effects || []).map((e, i) => `
                <div class="effect-item">
                    <div class="effect-header"><span>Effect ${i + 1}</span><button class="btn btn-small" onclick="removeEffect(${i})">X</button></div>
                    <div class="form-group"><label>Effect ID</label><input type="text" value="${e.effectId}" onchange="updateEffect(${i}, 'effectId', this.value)"></div>
                    <div class="stat-row"><label>Duration</label><input type="number" value="${e.duration}" min="0" step="0.1" onchange="updateEffect(${i}, 'duration', parseFloat(this.value))"></div>
                    <div class="stat-row"><label>Stacks</label><input type="number" value="${e.stacks}" min="1" onchange="updateEffect(${i}, 'stacks', parseInt(this.value))"></div>
                </div>`).join('');
            updateTimeline();
        }

        function updateEffect(i, k, v) { saveUndoState(); configData.effects[i][k] = v; setDirty(true); }
        function removeEffect(i) { saveUndoState(); configData.effects.splice(i, 1); updateEffectsList(); setDirty(true); }

        function updateTimeline() {
            const track = document.getElementById('timeline-track');
            const duration = parseFloat(document.getElementById('timeline-total').value) || 2;
            track.innerHTML = (configData.effects || []).map((e, i) => {
                const start = (e.delay || 0) / duration * 100;
                const width = Math.min(((e.duration || 1) / duration * 100), 100 - start);
                return `<div class="timeline-event" style="left:${start}%;width:${width}%">${e.effectId || 'Effect'}</div>`;
            }).join('');
        }

        function updateTimelineDuration() {
            document.getElementById('timeline-duration').textContent = document.getElementById('timeline-total').value + 's';
            updateTimeline();
        }

        function previewSpell() {
            updateTargetingPreview();
            // Animate spell preview
        }

        function toggleAOEView() { updateTargetingPreview(); }
        function toggleRangeView() { /* Show range circle */ }

        function populateForm() {
            document.querySelectorAll('[data-path]').forEach(input => {
                setInputValue(input, getPath(configData, input.getAttribute('data-path')));
            });
            updateEffectsList();
        }

        function loadConfig() { viewerBridge.browseFile('*.json').then(p => p && loadConfigFromPath(p)); }
        function loadConfigFromPath(p) { currentFile = p; viewerBridge.loadConfig(p).then(d => { configData = d; originalData = JSON.parse(JSON.stringify(d)); populateForm(); updateTargetingPreview(); document.getElementById('spell-title').textContent = d.name || 'Spell Viewer'; setDirty(false); }); }
        function saveConfig() { if (!currentFile) viewerBridge.browseFile('*.json').then(p => { if (p) { currentFile = p; doSave(); } }); else doSave(); }
        function doSave() { viewerBridge.saveConfig(currentFile, configData).then(() => { originalData = JSON.parse(JSON.stringify(configData)); setDirty(false); }); }

        function saveUndoState() { undoStack.push(JSON.parse(JSON.stringify(configData))); redoStack = []; if (undoStack.length > 50) undoStack.shift(); }
        function undo() { if (!undoStack.length) return; redoStack.push(JSON.parse(JSON.stringify(configData))); configData = undoStack.pop(); populateForm(); updateTargetingPreview(); setDirty(true); }
        function redo() { if (!redoStack.length) return; undoStack.push(JSON.parse(JSON.stringify(configData))); configData = redoStack.pop(); populateForm(); updateTargetingPreview(); setDirty(true); }

        function toggleSection(h) { h.parentElement.classList.toggle('collapsed'); }
        function setDirty(d) { document.getElementById('dirty-indicator').style.display = d ? 'inline' : 'none'; }
        function goBack() { if (document.getElementById('dirty-indicator').style.display !== 'none' && !confirm('Discard changes?')) return; window.history.back(); }
        function resetCamera() { viewerScene.resetCamera(); }
        function browseIcon() { viewerBridge.browseFile('*.png,*.jpg').then(p => { if (p) { setPath(configData, 'icon', p); document.querySelector('[data-path="icon"]').value = p; setDirty(true); } }); }
        function browsePython() { viewerBridge.browseFile('*.py').then(p => { if (p) { setPath(configData, 'callbacks.script', p); document.querySelector('[data-path="callbacks.script"]').value = p; setDirty(true); } }); }
        function testScript() { if (pythonEditor) viewerBridge.executePython(pythonEditor.getValue()); }

        function getPath(o, p) { if (!p) return o; const ps = p.split('.'); let c = o; for (const x of ps) { if (c == null) return undefined; c = c[x]; } return c; }
        function setPath(o, p, v) { const ps = p.split('.'); let c = o; for (let i = 0; i < ps.length - 1; i++) { if (c[ps[i]] === undefined) c[ps[i]] = {}; c = c[ps[i]]; } c[ps[ps.length - 1]] = v; }
        function getInputValue(i) { if (i.type === 'checkbox') return i.checked; if (i.type === 'number') return parseFloat(i.value) || 0; return i.value; }
        function setInputValue(i, v) { if (i.type === 'checkbox') i.checked = !!v; else i.value = v != null ? v : ''; }

        document.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveConfig(); } if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); } });
    </script>
</body>
</html>
